service: etra

frameworkVersion: '3'

custom:
  stage: ${opt:stage, 'dev'}

  # ---------------- IAM ROLES ----------------
  role:
    dev: arn:aws:iam::628897991898:role/lambdaexecutionrole
    stage: arn:aws:iam::135724561823:role/lambdaexecutionrole
    main: arn:aws:iam::669633198436:role/lambdaexecutionrole

  # ---------------- VPC ----------------
  vpc:
    dev:
      securityGroupIds:
        - sg-046b82ae67bfd26fb
      subnetIds:
        - subnet-03d7cb77bed1870a9

    stage:
      securityGroupIds:
        - sg-023522aad0d377362
      subnetIds:
        - subnet-0b2e2cae82b4aca2b

    main:
      securityGroupIds:
        - sg-023522aad0d377362
      subnetIds:
        - subnet-0b2e2cae82b4aca2b

  # ---------------- DEPLOYMENT BUCKET (FIXED) ----------------
  deploymentBucket:
    dev: lambda-bucket-dev1
    stage: lambda-bucket-stage1
    main: lambda-bucket-main1

provider:
  name: aws
  stage: ${self:custom.stage}
  region: us-east-2
  runtime: php-81-fpm
  architecture: arm64
  timeout: 29

  tracing:
    lambda: true

  # Environment variables from SSM Parameter Store
  environment:
    MYSQL_HOST: ${ssm:dbHost}
    MYSQL_DATABASE: ${ssm:dbName}
    MYSQL_USER: ${ssm:dbUser}
    MYSQL_PASSWORD: ${ssm:dbPass}
    DB_PORT: "3306"

  role: ${self:custom.role.${self:custom.stage}}

  vpc:
    securityGroupIds: ${self:custom.vpc.${self:custom.stage}.securityGroupIds}
    subnetIds: ${self:custom.vpc.${self:custom.stage}.subnetIds}

  deploymentBucket:
    name: ${self:custom.deploymentBucket.${self:custom.stage}}

plugins:
  - ./vendor/bref/bref

# =================================================================
# FUNCTIONS â€“ ALL LAMBDAS INCLUDED, STAGE-PREFIXED URLS
# =================================================================

functions:
  test:
    handler: test/test.php
    events:
      - httpApi:
          path: /${self:provider.stage}/test
          method: "*"

  create-sms-lambda:
    handler: create-sms/create-sms-lambda.php
    events:
      - httpApi:
          path: /${self:provider.stage}/create-sms-lambda
          method: "*"

  sms-lambda:
    handler: dosms/sms-lambda.php
    events:
      - httpApi:
          path: /${self:provider.stage}/sms-lambda
          method: "*"

  email-lambda:
    handler: doemail/email-lambda.php
    events:
      - httpApi:
          path: /${self:provider.stage}/email-lambda
          method: "*"

  refills-lambda:
    handler: refills/refills-lambda.php
    events:
      - httpApi:
          path: /${self:provider.stage}/refills-lambda
          method: "*"

  refills-mass-lambda:
    handler: refills-mass/refills-mass-lambda.php
    events:
      - httpApi:
          path: /${self:provider.stage}/refills-mass-lambda
          method: "*"

  socialmedia-api-lambda:
    handler: socialmedia-api/socialmedia-api-lambda.php
    events:
      - httpApi:
          path: /${self:provider.stage}/socialmedia-api-lambda
          method: "*"

  supplier-lambda:
    handler: supplier/supplier-lambda.php
    timeout: 120
    events:
      - httpApi:
          path: /${self:provider.stage}/supplier-lambda
          method: "*"

  autofulfill-free-lambda:
    handler: auto-fulfill-free/autofulfill-free-lambda.php
    timeout: 180
    events:
      - httpApi:
          path: /${self:provider.stage}/autofulfill-free-lambda
          method: "*"

  autofulfill-lambda:
    handler: auto-fulfill/autofulfill-lambda.php
    timeout: 180
    events:
      - httpApi:
          path: /${self:provider.stage}/autofulfill-lambda
          method: "*"

  download-thumbs-lambda:
    handler: download-thumbs/download-thumbs-lambda.php
    events:
      - httpApi:
          path: /${self:provider.stage}/download-thumbs-lambda
          method: "*"

  download-thumbs-api-lambda:
    handler: download-thumbs-api/download-thumbs-lambda.php
    timeout: 120
    events:
      - httpApi:
          path: /${self:provider.stage}/download-thumbs-api-lambda
          method: "*"

  download-thumbs-retry-api-lambda:
    handler: download-thumbs-retry-api/download-thumbs-retry-lambda.php
    timeout: 120
    events:
      - httpApi:
          path: /${self:provider.stage}/download-thumbs-retry-api-lambda
          method: "*"

  manjur-lambda:
    handler: manjur/manjur-lambda.php
    timeout: 120
    events:
      - httpApi:
          path: /${self:provider.stage}/manjur-lambda
          method: "*"

  checkorderfulfilled-lambda:
    handler: checkorderfulfilled/checkorderfulfilled-lambda.php
    timeout: 120
    events:
      - httpApi:
          path: /${self:provider.stage}/checkorderfulfilled-lambda
          method: "*"

  free-followers-lambda:
    handler: free-followers/free-followers-lambda.php
    events:
      - httpApi:
          path: /${self:provider.stage}/free-followers-lambda
          method: "*"

  free-likes-lambda:
    handler: free-likes/free-likes-lambda.php
    events:
      - httpApi:
          path: /${self:provider.stage}/free-likes-lambda
          method: "*"

  sentinel:
    handler: sentinel/initiate-tests.php
    events:
      - httpApi:
          path: /${self:provider.stage}/sentinel
          method: "*"

  autofulfill-clear-lambda:
    handler: auto-fulfill-clear/autofulfill-clear-lambda.php
    events:
      - httpApi:
          path: /${self:provider.stage}/autofulfill-clear-lambda
          method: "*"

  autofulfill-free-clear-lambda:
    handler: auto-fulfill-free-clear/autofulfill-free-clear-lambda.php
    events:
      - httpApi:
          path: /${self:provider.stage}/autofulfill-free-clear-lambda
          method: "*"

  run-query-lambda:
    handler: run-query/run-query-lambda.php
    events:
      - httpApi:
          path: /${self:provider.stage}/run-query-lambda
          method: "*"

  check-account-status-lambda:
    handler: check-account-status/check-account-status-lambda.php
    timeout: 120
    events:
      - httpApi:
          path: /${self:provider.stage}/check-account-status-lambda
          method: "*"

  preloadpost-lambda:
    handler: preloadpost/preloadpost-lambda.php
    timeout: 120
    events:
      - httpApi:
          path: /${self:provider.stage}/preloadpost-lambda
          method: "*"

  preloadpost-tiktok-lambda:
    handler: preloadpost-tiktok/preloadpost-tiktok-lambda.php
    timeout: 120
    events:
      - httpApi:
          path: /${self:provider.stage}/preloadpost-tiktok-lambda
          method: "*"
